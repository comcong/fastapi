<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>실시간 체결 통보</title>
    <style>
        .summary {
            display: grid;
            grid-template-columns: auto 1fr;
            column-gap: 80px;
            width: 100%;
            font-family: monospace;
            font-size: 16px;
            line-height: 1.8;
        }
        .summary .num {
            text-align: right;
        }

        body {
            font-family: Arial, sans-serif;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 10px;
        }

        th, td {
            border: 1px solid #aaa;
            padding: 8px;
            text-align: center;
        }

        th {
            background-color: #eee;
        }

        th, td {
    border: 1px solid #aaa;
    padding: 8px;
    text-align: center;
    }

    th {
        background-color: #eee;
    }

    /* 정렬 아이콘 */
    th {
        cursor: pointer;
    }

        #messages {
            margin-top: 20px;
            padding: 10px;
            background: #f9f9f9;
            border: 1px solid #ccc;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .message-line {
            margin: 5px 0;
        }

        .sell-button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .sell-button:hover {
            background-color: #c82333;
        }

        .sell-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .profit-positive {
            color: #dc3545;
            font-weight: bold;
        }

        .profit-negative {
            color: #28a745;
            font-weight: bold;
        }

        .profit-zero {
            color: #6c757d;
        }
    </style>
</head>
<body>

    <!-- 잔고/평가금액/매수가능금액 표시 -->
    <div class="summary">
        <div>잔고:</div>
        <div class="num" id="balance_value">{{ '{:,}'.format(balance|int) if balance is not none else '-' }}</div>

        <div>평가금액:</div>
        <div class="num" id="tot_acc_value">{{ '{:,}'.format(tot_acc_value|int) if tot_acc_value is not none else '-' }}</div>
        <div>이익금:</div>
        <div class="num {{ 'profit-positive' if acc_profit|default(0) > 0 else
                   'profit-negative' if acc_profit|default(0) < 0 else
                   'profit-zero' }}"
             id="acc_profit">
            {{ acc_profit|default('-')|int|string }}
        </div>
        <div>매수가능금액:</div>
        <div class="num" id="d2_cash">{{ '{:,}'.format(d2_cash|int) if d2_cash is not none else '-' }}</div>
    </div>

    <!-- 체결 데이터 테이블 -->
    <table id="data_table">
        <thead>
            <tr>
                <th onclick="sortTable(0)">매수_주문번호 </th>
                <th onclick="sortTable(1)">종목명 </th>
                <th onclick="sortTable(2)">종목코드 </th>
                <th onclick="sortTable(3)">체결시간 </th>
                <th onclick="sortTable(4)">주문수량 </th>
                <th onclick="sortTable(5)">체결수량 </th>
                <th onclick="sortTable(6)">체결단가 </th>
                <th onclick="sortTable(7)">현재가 </th>
                <th onclick="sortTable(8)">수익률 </th>
                <th onclick="sortTable(9)">매도_주문가격 </th>
                <th onclick="sortTable(10)">매도_주문수량 </th>
                <th onclick="sortTable(11)">체결잔량 </th>
                <th onclick="sortTable(12)">매도_주문번호 </th>
                <th>매도</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- 메시지 로그 -->
    <h1>메시지 로그</h1>
    <div id="messages"></div>

<script>

const protocol = location.protocol === "https:" ? "wss" : "ws"; // 현재 페이지가 HTTPS이면 wss, 아니면 ws 사용
const ws = new WebSocket(`${protocol}://${location.host}/ws`);  // WebSocket 서버 연결 생성
const tableBody = document.querySelector("#data_table tbody"); // 테이블 tbody 선택
const messageBox = document.getElementById("messages");        // 메시지 박스 선택

// 정렬 함수
function sortTable(n) {
    var table = document.getElementById("data_table");
    var rows = Array.from(table.rows).slice(1); // 헤더 제외
    var ths = table.querySelectorAll("th");

    // 현재 정렬 상태 확인
    var currentSortCol = table.getAttribute("data-sort-col");
    var currentSortOrder = table.getAttribute("data-sort-order");

    var asc = !(currentSortCol == n && currentSortOrder == "asc");

    // 상태 저장
    table.setAttribute("data-sort-col", n);
    table.setAttribute("data-sort-order", asc ? "asc" : "desc");

    // 모든 헤더에서 정렬 클래스 제거
    ths.forEach(th => th.classList.remove("sorted-asc", "sorted-desc"));

    // 클릭한 헤더에만 클래스 추가
    ths[n].classList.add(asc ? "sorted-asc" : "sorted-desc");

    // 정렬 실행
    rows.sort(function(a, b) {
        var x = a.cells[n].innerText.trim();
        var y = b.cells[n].innerText.trim();

        // 숫자 비교
        var numX = parseFloat(x.replace(/,/g, ""));
        var numY = parseFloat(y.replace(/,/g, ""));

        // 체결시간(컬럼 index 3)만 data-time 기준으로 Date 비교
        if (n === 3) {
            var dateX = new Date(a.cells[n].getAttribute("data-time"));
            var dateY = new Date(b.cells[n].getAttribute("data-time"));
            return asc ? dateX - dateY : dateY - dateX;
        }

        if (!isNaN(numX) && !isNaN(numY)) {
            return asc ? numX - numY : numY - numX;
        }
        return asc ? x.localeCompare(y) : y.localeCompare(x);
    });

    // 정렬된 행을 다시 테이블에 붙여주기
    rows.forEach(row => table.tBodies[0].appendChild(row));
}

// 수익률 계산 함수
function calculateProfitRate(체결단가, 현재가) {
    const feeRate = 0.00015;
    const taxRate = 0.0015;

    const buyPrice = parseInt(체결단가, 10);
    const currentPrice = parseInt(현재가, 10);

    // 현재가나 체결단가가 없으면 빈 문자열 반환
    if (isNaN(buyPrice) || buyPrice === 0 || isNaN(currentPrice)) {
        return "";
    }

    const buyFee = buyPrice * feeRate;
    const sellFee = currentPrice * feeRate;
    const tax = currentPrice * taxRate;

    const profitRate = ((currentPrice - buyPrice - buyFee - sellFee - tax) / buyPrice) * 100;
    return profitRate.toFixed(2); // 소수점 2자리 문자열
}

// 숫자를 천 단위 콤마로 포맷
function formatNumber(n) {
    const num = Number(n);
    return Number.isFinite(num) ? num.toLocaleString('ko-KR') : n;
}

// 수익률 CSS 클래스 결정
function getProfitClass(profitRate) {
    if (!profitRate) return 'profit-zero';
    const rate = parseFloat(profitRate);
    if (rate > 0) return 'profit-positive';
    if (rate < 0) return 'profit-negative';
    return 'profit-zero';
}

// 매도 버튼 클릭 함수
function handleSellClick(orderNumber, stockCode, stockName, quantity, currentPrice, buttonEl) {
    const input = prompt(
        `매도 가격을 입력하세요.\n현재가: ${currentPrice}원`,
        String(currentPrice)
    );
    if (input === null) return;

    const trimmed = input.trim();
    let chosenPrice = trimmed === '' ? Number(currentPrice) : Number(trimmed.replace(/,/g, ''));
    if (isNaN(chosenPrice) || chosenPrice <= 0) {
        alert('유효한 가격을 입력하세요.');
        return;
    }

    if (!confirm(`정말로 ${stockName}(${stockCode}) ${quantity}주를 매도하시겠습니까?\n매도 가격: ${chosenPrice}원`)) {
        return;
    }

    // 매도 요청 객체 생성 및 전송
    const sellRequest = {
        type: "sell_order",
        data: {
            order_number: orderNumber,
            stock_code: stockCode,
            stock_name: stockName,
            quantity: quantity,
            current_price: String(chosenPrice)
        }
    };
    ws.send(JSON.stringify(sellRequest));
    console.log('매도 요청 전송:', sellRequest);
}

// 서버 메시지 수신 처리
ws.onmessage = function(event) {
    const parsed = JSON.parse(event.data);

    // 잔고 업데이트
    if (parsed.type === "balance") {
        const data = parsed.data;
        const balanceEl = document.getElementById('balance_value');
        const totAccEl = document.getElementById('tot_acc_value');
        const accProfitEl = document.getElementById('acc_profit');
        const d2CashEl = document.getElementById('d2_cash');

        if (balanceEl) balanceEl.textContent = formatNumber(data.balance);
        if (totAccEl) totAccEl.textContent = formatNumber(data.tot_acc_value);
        if (accProfitEl) {
            const profit = Number(data.acc_profit);
            accProfitEl.textContent = formatNumber(profit);
            accProfitEl.className = 'num ' + (
                profit > 0 ? 'profit-positive' :
                profit < 0 ? 'profit-negative' :
                'profit-zero'
            );
        }
        if (d2CashEl) d2CashEl.textContent = formatNumber(data.d2_cash);
        return;
    }

    // 체결 데이터 업데이트
    if (parsed.type === "stock_data") {
        const data = parsed.data;
        tableBody.innerHTML = "";

        if (!data || data.length === 0) {
            const tr = document.createElement("tr");
            const td = document.createElement("td");
            td.colSpan = 14;
            td.textContent = "데이터가 없습니다.";
            td.style.fontStyle = "italic";
            tr.appendChild(td);
            tableBody.appendChild(tr);
            return;
        }

        data.forEach(row => {
            const tr = document.createElement("tr");
            const keys = [
                "매수_주문번호", "종목명", "종목코드", "체결시간",
                "주문수량", "체결수량", "체결단가", "현재가", "수익률",
                "매도_주문가격", "매도_주문수량", "체결잔량", "매도_주문번호"
            ];

            keys.forEach(key => {
                const td = document.createElement("td");
                let value = row[key] || "";

                // 체결시간 포맷
                if (key === "체결시간") {
                    const s = value;
                    if (s.length === 12) {
                        const yyyy = '20' + s.slice(0, 2);
                        const mm = s.slice(2, 4);
                        const dd = s.slice(4, 6);
                        const hh = s.slice(6, 8);
                        const mi = s.slice(8, 10);
                        const ss = s.slice(10, 12);

                        td.textContent = `${yyyy}년${mm}월${dd}일 ${hh}시${mi}분${ss}초`;
                        td.setAttribute("data-time", `${yyyy}-${mm}-${dd}T${hh}:${mi}:${ss}`);
                    } else {
                        td.textContent = value;
                    }
                }

                // 수익률 계산
                if (key === "수익률") {
                    const profitRate = calculateProfitRate(row.체결단가, row.현재가);
                    td.className = getProfitClass(profitRate);
                    value = profitRate ? profitRate + '%' : "";
                    td.textContent = value;
                }

                const rightAlignKeys = ["주문수량", "체결수량", "체결단가", "현재가", "수익률", "매도_주문가격", "매도_주문수량", "체결잔량"];
                if (rightAlignKeys.includes(key)) td.style.textAlign = "right";

                if (key !== "체결시간" && key !== "수익률") td.textContent = value;

                tr.appendChild(td);
            });

            // 매도 버튼
            const sellTd = document.createElement("td");
            const sellButton = document.createElement("button");
            sellButton.className = "sell-button";
            sellButton.textContent = row["매도_주문번호"] ? "정정" : "매도";
            sellButton.onclick = function() {
                if (row["매도_주문번호"]) {
                    alert("이미 매도 주문이 체결된 상태입니다.");
                    return;
                }
                handleSellClick(
                    row["매수_주문번호"],
                    row["종목코드"],
                    row["종목명"],
                    row["체결수량"],
                    row["현재가"],
                    this
                );
            };
            sellTd.appendChild(sellButton);
            tr.appendChild(sellTd);

            tableBody.appendChild(tr);
        });
    }

    // 일반 메시지 로그
    if (parsed.type === "message") {
        const msg = parsed.data;
        const div = document.createElement("div");
        div.className = "message-line";
        div.textContent = typeof msg === 'object' ? JSON.stringify(msg, null, 2) : msg;
        messageBox.innerHTML = "";
        messageBox.appendChild(div);
        messageBox.scrollTop = messageBox.scrollHeight;
    }

    // 매도 결과 메시지
    if (parsed.type === "sell_result") {
        const result = parsed.data;
        const div = document.createElement("div");
        div.className = "message-line";
        div.style.color = result.success ? "green" : "red";
        div.textContent = `매도 결과: ${result.message}`;
        messageBox.appendChild(div);
        messageBox.scrollTop = messageBox.scrollHeight;
    }
};

// WebSocket 이벤트
ws.onopen = function() { console.log('웹소켓 연결됨'); };
ws.onerror = function(error) { console.error('웹소켓 오류:', error); };
ws.onclose = function() { console.log('웹소켓 연결 종료'); };

</script>

</body>
</html>

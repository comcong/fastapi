<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>실시간 체결 통보</title>
    <style>
        .summary {
            display: grid;
            grid-template-columns: auto 1fr;
            column-gap: 80px;
            width: 100%;
            font-family: monospace;
            font-size: 16px;
            line-height: 1.8;
        }
        .summary .num {
            text-align: right;
        }

        body {
            font-family: Arial, sans-serif;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 10px;
        }

        th, td {
            border: 1px solid #aaa;
            padding: 8px;
            text-align: center;
        }

        th {
            background-color: #eee;
        }

        #messages {
            margin-top: 20px;
            padding: 10px;
            background: #f9f9f9;
            border: 1px solid #ccc;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .message-line {
            margin: 5px 0;
        }

        .sell-button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .sell-button:hover {
            background-color: #c82333;
        }

        .sell-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .profit-positive {
            color: #dc3545;
            font-weight: bold;
        }

        .profit-negative {
            color: #28a745;
            font-weight: bold;
        }

        .profit-zero {
            color: #6c757d;
        }
    </style>
</head>
<body>

    <div class="summary">
        <div>잔고:</div>
        <div class="num" id="balance_value">{{ '{:,}'.format(balance|int) if balance is not none else '-' }}</div>
        <div>평가금:</div><div class="num">554,885</div>
        <div>매수가능금액:</div><div class="num">11,235</div>
    </div>

    <table id="data_table">
        <thead>
            <tr>
                <th>매수_주문번호</th>
                <th>종목명</th>
                <th>종목코드</th>
                <th>체결시간</th>
                <th>주문수량</th>
                <th>체결수량</th>
                <th>체결단가</th>
                <th>현재가</th>
                <th>수익률</th>
                <th>매도_주문가격</th>
                <th>매도_주문수량</th>
                <th>체결잔량</th>
                <th>매도_주문번호</th>
                <th>매도</th>
          </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h1>메시지 로그</h1>
    <div id="messages"></div>




<script>

const protocol = location.protocol === "https:" ? "wss" : "ws";     // 현재 페이지가 HTTPS이면 wss, 아니면 ws 사용
const ws = new WebSocket(`${protocol}://${location.host}/ws`);      // WebSocket 서버 연결 생성

// 테이블 tbody와 메시지 박스 DOM 참조
const tableBody = document.querySelector("#data_table tbody");     // id가 "data_table" 안에서 <tbody> 선택
const messageBox = document.getElementById("messages");            // id가 "messages" 선택

// 매도_주문번호를 localStorage 에서 soldOrderNumbers 키 값을 Set으로 저장, 해당 키가 없으면 빈 리스트
let soldOrderNumbers = new Set(JSON.parse(localStorage.getItem('soldOrderNumbers') || '[]'));

// 숫자를 한국식 천 단위 콤마로 포맷
function formatNumber(n) {
    const num = Number(n);
    return Number.isFinite(num) ? num.toLocaleString('ko-KR') : n;
}

// 체결시간 문자열(YYYYMMDDhhmmss)을 읽기 쉽게 포맷
function formatTimeString(hhmmss) {
    if (typeof hhmmss !== 'string' || hhmmss.length !== 12) return hhmmss;
    return hhmmss.slice(0, 2) + '년' + hhmmss.slice(2, 4) + '월' + hhmmss.slice(4, 6) + '일 ' +
           hhmmss.slice(6, 8) + '시' + hhmmss.slice(8, 10) + '분' + hhmmss.slice(10, 12) + '초';
}

// 수익률에 따라 CSS 클래스 반환 (색상 표시용)
function getProfitClass(profitRate) {
    if (!profitRate) return 'profit-zero';
    const rate = parseFloat(profitRate);
    if (rate > 0) return 'profit-positive';
    if (rate < 0) return 'profit-negative';
    return 'profit-zero';
}

// 매도 버튼 클릭 시 실행되는 함수
function handleSellClick(orderNumber, stockCode, stockName, quantity, currentPrice, buttonEl) {
    // 매도 가격 입력 받기 (prompt)
    const input = prompt(
        `매도 가격을 입력하세요.\n현재가: ${currentPrice}원`,
        String(currentPrice)
    );
    if (input === null) return; // 취소하면 종료

    const trimmed = input.trim();
    let chosenPrice = trimmed === '' ? Number(currentPrice) : Number(trimmed.replace(/,/g, ''));
    if (isNaN(chosenPrice) || chosenPrice <= 0) { // 유효성 검사
        alert('유효한 가격을 입력하세요.');
        return;
    }

    // 최종 확인
    if (!confirm(`정말로 ${stockName}(${stockCode}) ${quantity}주를 매도하시겠습니까?\n매도 가격: ${chosenPrice}원`)) {
        return;
    }

    // 매도 요청 객체 생성
    const sellRequest = {
        type: "sell_order",
        data: {
            order_number: orderNumber,
            stock_code: stockCode,
            stock_name: stockName,
            quantity: quantity,
            current_price: String(chosenPrice)
        }
    };
    // WebSocket으로 서버로 전송
    ws.send(JSON.stringify(sellRequest));

    // localStorage에 매도 주문 저장
    soldOrderNumbers.add(orderNumber);
    localStorage.setItem('soldOrderNumbers', JSON.stringify([...soldOrderNumbers]));

    // 버튼 텍스트 변경 ("정정"으로)
    if (buttonEl) {
        buttonEl.textContent = '정정';
    }

    console.log('매도 요청 전송:', sellRequest);
}




// WebSocket으로 메시지 수신 시 처리
ws.onmessage = function(event) {
    const parsed = JSON.parse(event.data); // JSON 파싱

    // 잔고 업데이트
    if (parsed.type === "balance") {                             // 서버에서 받은 메시지 타입이 "balance"(잔고 정보)인지 확인
        const el = document.getElementById('balance_value');     // HTML에서 id="balance_value"인 요소 가져오기
        if (el) el.textContent = formatNumber(parsed.data);      // 요소가 존재하는지 확인 (null 방지) 하여 // 가져온 데이터를 숫자 포맷팅 후 DOM의 텍스트로 업데이트
        return;                                                  // balance 처리 후 함수 종료
    }


    // 테이블 업데이트
    if (parsed.type === "stock_data") {                      // 서버에서 받은 메시지 타입이 "stock_data"(체결 데이터)인지 확인
        const data = parsed.data;                            // 수신된 체결 데이터 배열을 data 변수에 저장
        tableBody.innerHTML = "";                            // 기존 테이블 내용을 모두 비워 초기화

        // 데이터가 없으면 "데이터가 없습니다" 표시
        if (!data || data.length === 0) {                    // data가 비었거나 null/undefined일 경우
            const tr = document.createElement("tr");         // <tr> 행 요소 생성
            const td = document.createElement("td");         // <td> 셀 요소 생성
            td.colSpan = data.length;       // 14            // 테이블 컬럼 개수만큼 병합 (여기서는 14)
            td.textContent = "데이터가 없습니다.";              // 셀에 메시지 텍스트 삽입
            td.style.fontStyle = "italic";                   // 폰트를 이탤릭체로 지정
            tr.appendChild(td);                              // <td>를 <tr> 안에 추가
            tableBody.appendChild(tr);                       // <tr>를 테이블 본문에 추가
            return;                                          // 이후 로직은 실행하지 않고 종료
        }

        // 데이터 행 생성
        data.forEach(row => {                                 // data 배열 돌면서 <tr>행 생성
        const tr = document.createElement("tr");              // <tr>행 생성

        // 테이블에 표시할 데이터 key 순서 정의
        const keys = ["매수_주문번호", "종목명", "종목코드", "체결시간", "주문수량", "체결수량", "체결단가", "현재가", "수익률", "매도_주문가격", "매도_주문수량", "체결잔량", "매도_주문번호"];


        // 각 컬럼 생성
        keys.forEach(key => {                        // keys 배열을 돌면서 각 <td> 셀 생성
        const td = document.createElement("td");     // <td> 셀 생성
        let value = row[key] || "";                  // 현재 row에서 해당 key 값 가져오기 (없으면 빈 문자열)
        if (key === "체결시간") {                     // 만약 컬럼이 "체결시간"이면
            value = formatTimeString(value);         // 시간 포맷팅 함수 적용
        }

        if (key === "수익률") {                                     // 만약 컬럼이 "수익률"이면
            td.className = getProfitClass(value);                  // 수익률 값에 따라 class 지정 (양수/음수 색상)
            if (value) {                                           // 값이 있으면
                const num = parseFloat(value);                     // 문자열 → 숫자 변환
                if (!isNaN(num)) {                                 // 숫자로 변환이 되면
                    value = num.toFixed(2) + '%';                  // 소수점 둘째 자리까지 고정 + %
                    }
                }
            }
            td.textContent = value;
            tr.appendChild(td);
        });


        // 매도 버튼 컬럼 생성
        const sellTd = document.createElement("td");             // 매도 버튼을 담을 <td> 셀 생성
        const sellButton = document.createElement("button");    // <button> 요소 생성
        sellButton.className = "sell-button";                   // 버튼에 CSS 클래스 지정
        // 이미 매도한 주문이면 "정정", 아니면 "매도" 버튼 표시
        sellButton.textContent = soldOrderNumbers.has(row["매수_주문번호"]) ? "정정" : "매도";
        sellButton.onclick = function() {                     // 버튼 클릭 시 실행할 이벤트 핸들러 등록
            handleSellClick(
                row["매수_주문번호"],                           // 매수 주문번호
                row["종목코드"],                               // 종목코드
                row["종목명"],                                // 종목명
                row["체결수량"],                               // 체결수량
                row["현재가"],                                // 현재가
                this                                         // 클릭된 버튼 자신
            );
        };
        sellTd.appendChild(sellButton);                  // 버튼을 <td> 안에 추가
        tr.appendChild(sellTd);                          // <td>를 <tr>에 추가

        tableBody.appendChild(tr);                       // 완성된 <tr>를 테이블 본문에 추가
        });
    }

    // 일반 메시지 로그
    if (parsed.type === "message") {
        const msg = parsed.data;
        const div = document.createElement("div");
        div.className = "message-line";
        div.textContent = typeof msg === 'object' ? JSON.stringify(msg, null, 2) : msg;
        messageBox.innerHTML = "";                                 // 기존 로그 초기화
        messageBox.appendChild(div);
        messageBox.scrollTop = messageBox.scrollHeight;            // 스크롤 맨 아래
    }

    // 매도 주문시 반환 데이터
    if (parsed.type === "sell_result") {
        const result = parsed.data;
        const div = document.createElement("div");
        div.className = "message-line";
        div.style.color = result.success ? "green" : "red";            // 성공/실패 색상
        div.textContent = `매도 결과: ${result.message}`;
        messageBox.appendChild(div);
        messageBox.scrollTop = messageBox.scrollHeight;
    }
};

// WebSocket 연결 이벤트
ws.onopen = function() {
    console.log('웹소켓 연결됨');
};

// WebSocket 오류 이벤트
ws.onerror = function(error) {
    console.error('웹소켓 오류:', error);
};

// WebSocket 종료 이벤트
ws.onclose = function() {
    console.log('웹소켓 연결 종료');
};
</script>



</body>
</html>
